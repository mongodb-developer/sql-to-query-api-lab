# ğŸ‘ $merge

In MongoDB, the **$merge** stage allows you to **write the results of an aggregation pipeline into a new or existing collection**. This is similar to the concept of "INSERT INTO ... SELECT" or "MERGE INTO" in SQL databases.

---

## **ğŸ”¹ Understanding $merge**

The `$merge` stage enables you to store aggregation results into a different collection. If the target collection doesnâ€™t exist, MongoDB will create it automatically.

### **Key features:**

âœ”ï¸ Inserts new documents if they donâ€™t exist
âœ”ï¸ Updates existing documents based on `_id` or a specified field
âœ”ï¸ Can replace, merge, or discard duplicate records
âœ”ï¸ Useful for **ETL workflows, reporting tables, and maintaining summary data**

---

## **ğŸ”¹ Syntax**

```js
{ $merge: {
    into: "targetCollection",
    on: "_id", // Field to match existing records
    whenMatched: "merge", // Action when a match is found
    whenNotMatched: "insert" // Action when no match is found
} }
```

- **`into`** â†’ Specifies the target collection.
- **`on`** â†’ Defines how documents are matched (default: `_id`).
- **`whenMatched`** â†’ Specifies action when a document with the same key exists.
  - `merge`: Updates matching documents.
  - `replace`: Replaces matching documents.
  - `keepExisting`: Keeps the existing document unchanged.
  - `fail`: Throws an error on duplicates.
- **`whenNotMatched`** â†’ Specifies action when a match is not found.
  - `insert`: Inserts new documents.
  - `discard`: Ignores unmatched documents.
  - `fail`: Throws an error if a match is not found.

---

## **ğŸ”¹ Example 1: Creating a summary collection**

ğŸ‘‰ Suppose we want to generate a collection that contains the **total number of books per genre**.

```js
db.books.aggregate([
  { $unwind: "$genres" },
  { $group: { _id: "$genres", totalBooks: { $sum: 1 } } },
  {
    $merge: {
      into: "genre_summary",
      on: "_id",
      whenMatched: "merge",
      whenNotMatched: "insert",
    },
  },
]);
```

### **Equivalent SQL query**

```sql
INSERT INTO genre_summary (genre, totalBooks)
SELECT genre, COUNT(*) FROM books
GROUP BY genre
ON DUPLICATE KEY UPDATE totalBooks = VALUES(totalBooks);
```

---

## **ğŸ”¹ Example 2: Maintaining an author summary table**

ğŸ‘‰ We want to create an **author_stats** collection with the total number of books written by each author.

```js
db.books.aggregate([
  { $unwind: "$authors" },
  { $group: { _id: "$authors.name", totalBooks: { $sum: 1 } } },
  {
    $merge: {
      into: "author_stats",
      on: "_id",
      whenMatched: "merge",
      whenNotMatched: "insert",
    },
  },
]);
```

### **SQL equivalent**

```sql
INSERT INTO author_stats (authorName, totalBooks)
SELECT authors.name, COUNT(*) FROM books
GROUP BY authors.name
ON DUPLICATE KEY UPDATE totalBooks = VALUES(totalBooks);
```

---

## ğŸ‘ Challenge

ğŸ‘ Create a `top_rated_books` collection that stores books with an average rating above 4.5.

<details>
  <summary>Answer</summary>
    ```js
    db.books.aggregate([
      {
        $lookup:
          {
            from: "reviews",
            localField: "_id",
            foreignField: "bookId",
            as: "reviews"
          }
      }
    ]);
    ```
</details>
