import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

# üëê $lookup (JOINs in MongoDB)

`$lookup` in MongoDB serves a similar purpose to **JOINs** in SQL. It enables combining data from multiple collections by performing an equality match between fields.

---

## **üîπ Understanding $lookup**

The `$lookup` stage is used to fetch related documents from another collection, similar to `INNER JOIN` or `LEFT JOIN` in SQL.

### **Syntax**

```js
{
  $lookup: {
    from: "<foreign_collection>",  // Collection to join
    localField: "<local_field>",   // Field in current collection
    foreignField: "<foreign_field>", // Field in foreign collection
    as: "<output_array>"             // Output field
  }
}
```

- `from`: The target collection for joining.
- `localField`: The field in the current collection.
- `foreignField`: The field in the target collection.
- `as`: The output field containing the joined data as an array.

---

## üîπ Joining 2 collections

### üëê Example 1: Joining Authors collection with Books

üîç Get book details along with their authors

```js
db.authors.aggregate([
  {
    $lookup: {
      from: "books",
      localField: "books",
      foreignField: "_id",
      as: "booksWritten",
    },
  },
]);
```

### **Equivalent SQL query**

```sql
SELECT author.* , books_written.*
FROM authors
LEFT OUTER JOIN author_books ON authors.id = author_books.author_id
LEFT OUTER JOIN books as books_written ON author_books.book_id = books_written._id;
```

:::info
The result in MongoDB will have an array (`authorDetails`) instead of flat columns.
:::

---

## üîπ Handling unwinding ($unwind)

Since `$lookup` produces an **array**, we can flatten it using `$unwind`.

### Example 2: Get only book titles and single author name

```js
db.authors.aggregate([
  {
    $lookup: {
      from: "books",
      localField: "books",
      foreignField: "_id",
      as: "booksWritten",
    },
  },
  { $unwind: "$booksWritten" },
  { $project: { name: 1, "booksWritten.title": 1, _id: 0 } },
]);
```

:::info
The $lookup operation creates an array within each book document. Using $unwind then flattens this array, resulting in a separate document for every single book-author pair.
:::

---

## üëê Challenge

### üëê 1. Fetch books with their associated reviews

<details>
  <summary>Answer</summary>
  <Tabs groupId="challenges" defaultValue={"javascript"}>
    <TabItem value="javascript" label="JavaScript">
      <div>
        ```js
         await books.aggregate([
          {
            $lookup:
            {
              from: "reviews",
              localField: "_id",
              foreignField: "_id.bookId",
              as: "reviews"
            }
          }
        ]).toArray();
        ```
      </div>
    </TabItem>
    <TabItem value="mongosh" label="mongosh">
      <div>
        ```js
         db.books.aggregate([
          {
            $lookup:
            {
              from: "reviews",
              localField: "_id",
              foreignField: "_id.bookId",
              as: "reviews"
            }
          }
        ]);
        ```
      </div>
    </TabItem>
    <TabItem value="csharp" label="C#">
      <div>
      ```csharp
      var pipeline = booksCollection.Aggregate()
        .Lookup<Book, Review, Book>(
          foreignCollection: reviewsCollection,
          localField: b => b.Id,
          foreignField: r => r.BookId,
          @as: b => b.Reviews
        );

    var results = pipeline.ToList();
    ```
     </div>
  </TabItem>
    <TabItem value="python" label="Python">
      <div>
        ```python
        books_with_reviews = books.aggregate([
          {
            "$lookup":
            {
              "from": "reviews",
              "localField": "_id",
              "foreignField": "_id.bookId",
              "as": "reviews"
            }
          }
        ])
        ```
      </div>
    </TabItem>
     <TabItem value="java" label="Java">
      <div>
        ```java
        import com.mongodb.client.model.Aggregates;
        
        MongoCollection<Document> books = library.getCollection("books");

        books.aggregate(
          List.of(
            Aggregates.lookup(
              "reviews",
              "_id",
              "bookId",
              "reviews"
            )
          )
        ).forEach(r -> System.out.println(r.toJson()));
        ```
      </div>
    </TabItem>
  </Tabs>
</details>
